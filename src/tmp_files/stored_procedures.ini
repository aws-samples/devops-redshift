[sp1]
query1 = BEGIN 

[sp2]
query2 = BEGIN CREATE TABLE crown.mv_tbl__crow_poc_view__0__tmp BACKUP YES AS (WITH opAct as (   SELECT DISTINCT fos.user_oprtnl_id ,       du.first_name  as current_user_first_name ,       du.middle_name  as current_user_middle_name ,       du.last_name as current_user_last_name ,       sum(end_work_meter_sec - start_work_meter_sec)       over (partition by fos.user_oprtnl_id)  as work_time ,       --  rank() over (order by sum(end_work_meter_sec - start_work_meter_sec) over (partition by user_oprtn  l_id)) AS work_time_rank ,       sum(end_logon_meter_sec - start_logon_meter_sec)       over (partition by fos.user_oprtnl_id) AS logon_time   FROM (select end_work_meter_sec ,      start_work_meter_sec ,      user_oprtnl_id ,      dim_eqpmnt_id ,      end_logon_meter_sec ,      start_logon_meter_sec     from fact_operator_session fos --     where fos.location_oprtnl_id IN (7042 , 2886 , 4742 , 4743 , 2058 , 2059 , 2060 , 2765 , 6478 , 2064 , --                2066 , 2068 , 472 , 2072 , 9688 , 2073 , 474 , 475 , 477 , 478 , 862 , 479 , 480 , 11108 , --                2661 , 6760 , 8681)    ) fos      INNER JOIN (select dim_eqpmnt_id from dim_eqpmnt ) de ON fos.dim_eqpmnt_id = de.dim_eqpmnt_id      INNER JOIN (select first_name , middle_name , last_name , user_oprtnl_id , eqpmnt_role_id          from dim_user          where current_flag = 1          and user_type IN ('USER' , 'ERASED')          ) du ON fos.user_oprtnl_id = du.user_oprtnl_id ) , optActRank as (SELECT   user_oprtnl_id ,    current_user_first_name ,    current_user_middle_name ,    current_user_last_name ,    logon_time ,   work_time ,     rank () over (order by work_time desc) as work_time_rank_desc ,    -- rank () over ( order by work_time) as work_time_rank_asc ,    count(*) over () as cnt from opAct)  SELECT   user_oprtnl_id ,   current_user_first_name ,   current_user_middle_name ,   current_user_last_name ,   cnt AS opCnt ,   logon_time ,   work_time ,   work_time_rank_desc FROM   optActRank --  WHERE --  work_time_rank_desc <= 5 --    OR work_time_rank_desc > cnt - 5 UNION SELECT   NULL AS user_oprtnl_id ,   NULL AS current_user_first_name ,   NULL AS current_user_middle_name ,   NULL AS current_user_last_name ,   (CASE   WHEN COUNT(DISTINCT user_oprtnl_id) = 0 THEN NULL   ELSE COUNT(DISTINCT user_oprtnl_id)   END) AS opCnt ,   SUM(logon_time) / (CASE   WHEN COUNT(DISTINCT user_oprtnl_id) = 0 THEN NULL   ELSE COUNT(DISTINCT user_oprtnl_id)   END) AS logon_time ,   SUM(work_time) / (CASE   WHEN COUNT(DISTINCT user_oprtnl_id) = 0 THEN NULL   ELSE COUNT(DISTINCT user_oprtnl_id)   END) AS work_time ,   NULL AS work_time_rank_desc FROM   optActRank   );CREATE OR REPLACE VIEW  crown.crow_poc_view AS SELECT * FROM crown.mv_tbl__crow_poc_view__0__tmp;DROP TABLE crown.mv_tbl__crow_poc_view__0;ALTER TABLE crown.mv_tbl__crow_poc_view__0__tmp RENAME TO mv_tbl__crow_poc_view__0;CREATE OR REPLACE VIEW crown.crow_poc_view AS SELECT * FROM crown.mv_tbl__crow_poc_view__0; END; import td_business_calendar if indata <> '' : return td_business_calendar.TD_WEEK_BEGIN(indata ,calendar_name) else:  raise Exception('Wrong Format')  import td_business_calendar if indata <> '' : return td_business_calendar.TD_MONTH_BEGIN(indata ,calendar_name) else:  raise Exception('Wrong Format')  import td_business_calendar if indata <> '' : return td_business_calendar.TD_YEAR_BEGIN(indata ,calendar_name) else:  raise Exception('Wrong Format')  import td_business_calendar if indata <> '' : return td_business_calendar.TD_QUARTER_BEGIN(indata ,calendar_name) else:  raise Exception('Wrong Format')  

[sp3]
query3 = BEGIN SELECT * from adventureworksdw.dimdate; END;  

[sp4]
query4 = BEGIN CREATE TABLE public.mv_tbl__cancelled_flights__0__tmp BACKUP YES AS (  (select  count(1) , year  , month  , uniquecarrier  , airlineid  , case when code is null then 'misc' else code end as code  , case when description is null then 'misc' else description end as description from airline.on_time_on_time_performance_2016 x left outer join airline.l_cancellation y  on x.cancellationcode = y.code  group by  year  , month  , uniquecarrier  , airlineid  , code  , description  ));CREATE OR REPLACE VIEW  public.cancelled_flights AS SELECT * FROM public.mv_tbl__cancelled_flights__0__tmp;DROP TABLE public.mv_tbl__cancelled_flights__0;ALTER TABLE public.mv_tbl__cancelled_flights__0__tmp RENAME TO mv_tbl__cancelled_flights__0;CREATE OR REPLACE VIEW public.cancelled_flights AS SELECT * FROM public.mv_tbl__cancelled_flights__0; END;  

[sp5]
query5 = BEGIN IF Recompute_MV THEN EXECUTE $_4166391343746179141_$ CREATE TABLE "airline"."mv_tbl__cancelled_flights__0_recomputed" BACKUP YES  AS (SELECT "x"."year" AS "grvar_1" , "x"."month" AS "grvar_2" , "x"."uniquecarrier" AS "grvar_3" , "x"."airlineid" AS "grvar_4" , "x"."originstatename" AS "grvar_5" , "y"."code" AS "grvar_6" , CASE WHEN "y"."description" IS NULL THEN CAST('misc' AS VARCHAR) ELSE "y"."description" END AS "grvar_7" , COUNT(CAST(1 AS INT4)) AS "aggvar_1" , SUM(COALESCE("x"."carrierdelay" , CAST(0 AS INT4))) AS "aggvar_2" , COUNT(CAST(1 AS INT4)) AS "num_rec" FROM "airline"."l_cancellation" AS "y" , "airline"."on_time_on_time_performance_2016" AS "x" WHERE (((CAST("y"."insertxid" AS INT8) <= $_4166391343746179141_$ || end_xid || $_4166391343746179141_$) AND (CAST("y"."deletexid" AS INT8) > $_4166391343746179141_$ || end_xid || $_4166391343746179141_$)) AND ((CAST("x"."insertxid" AS INT8) <= $_4166391343746179141_$ || end_xid || $_4166391343746179141_$) AND (CAST("x"."deletexid" AS INT8) > $_4166391343746179141_$ || end_xid || $_4166391343746179141_$))) AND ("y"."code" = "x"."cancellationcode") GROUP BY "x"."year" , "x"."month" , "x"."uniquecarrier" , "x"."airlineid" , "x"."originstatename" , "y"."code" , CASE WHEN "y"."description" IS NULL THEN CAST('misc' AS VARCHAR) ELSE "y"."description" END) $_4166391343746179141_$ ; CREATE OR REPLACE VIEW "airline"."cancelled_flights" AS (SELECT "derived_table1"."aggvar_1" AS "totalcount" , "derived_table1"."aggvar_2" AS "carrierdelayagg" , "derived_table1"."grvar_1" AS "year" , "derived_table1"."grvar_2" AS "month" , "derived_table1"."grvar_3" AS "uniquecarrier" , "derived_table1"."grvar_4" AS "airlineid" , "derived_table1"."grvar_5" AS "originstatename" , "derived_table1"."grvar_6" AS "code_ed" , "derived_table1"."grvar_7" AS "description_ed" FROM "airline"."mv_tbl__cancelled_flights__0_recomputed" AS "derived_table1"); DROP TABLE "airline"."mv_tbl__cancelled_flights__0"; ALTER TABLE "airline"."mv_tbl__cancelled_flights__0_recomputed" RENAME TO "mv_tbl__cancelled_flights__0"; CREATE OR REPLACE VIEW "airline"."cancelled_flights" AS (SELECT "derived_table1"."aggvar_1" AS "totalcount" , "derived_table1"."aggvar_2" AS "carrierdelayagg" , "derived_table1"."grvar_1" AS "year" , "derived_table1"."grvar_2" AS "month" , "derived_table1"."grvar_3" AS "uniquecarrier" , "derived_table1"."grvar_4" AS "airlineid" , "derived_table1"."grvar_5" AS "originstatename" , "derived_table1"."grvar_6" AS "code_ed" , "derived_table1"."grvar_7" AS "description_ed" FROM "airline"."mv_tbl__cancelled_flights__0" AS "derived_table1"); ELSE EXECUTE $_4166391343746179141_$ CREATE TEMPORARY TABLE "mv_tbl__cancelled_flights__0_tmp" AS (SELECT "derived_table1"."X1" AS "grvar_1" , "derived_table1"."X2" AS "grvar_2" , "derived_table1"."X3" AS "grvar_3" , "derived_table1"."X4" AS "grvar_4" , "derived_table1"."X5" AS "grvar_5" , "derived_table1"."X6" AS "grvar_6" , CASE WHEN "derived_table1"."X7" IS NULL THEN CAST('misc' AS VARCHAR) ELSE "derived_table1"."X7" END AS "grvar_7" , SUM(CASE WHEN CAST(1 AS INT4) IS NULL THEN CAST(0 AS INT4) ELSE "derived_table1"."X8" END) AS "aggvar_1" , SUM((COALESCE("derived_table1"."X9" , CAST(0 AS INT4)) * "derived_table1"."X8")) AS "aggvar_2" , SUM("derived_table1"."X8") AS "num_rec" FROM ((SELECT "x"."year" AS "X1" , "x"."month" AS "X2" , "x"."uniquecarrier" AS "X3" , "x"."airlineid" AS "X4" , "x"."originstatename" AS "X5" , "y"."code" AS "X6" , "y"."description" AS "X7" , (CAST(1 AS INT4) * CAST(1 AS INT4)) AS "X8" , "x"."carrierdelay" AS "X9" , "x"."cancellationcode" AS "X10" FROM "airline"."l_cancellation" AS "y" , "airline"."on_time_on_time_performance_2016" AS "x" WHERE (((CAST("y"."insertxid" AS INT8) > $_4166391343746179141_$ || start_xid || $_4166391343746179141_$) OR CAST("y"."insertxid" AS INT8) IN $_4166391343746179141_$ || finished_xid_list || $_4166391343746179141_$) AND ((CAST("y"."insertxid" AS INT8) <= $_4166391343746179141_$ || end_xid || $_4166391343746179141_$) AND (CAST("y"."deletexid" AS INT8) > $_4166391343746179141_$ || end_xid || $_4166391343746179141_$))) AND ((CAST("x"."insertxid" AS INT8) <= $_4166391343746179141_$ || end_xid || $_4166391343746179141_$) AND (CAST("x"."deletexid" AS INT8) > $_4166391343746179141_$ || end_xid || $_4166391343746179141_$))) UNION ALL ((SELECT "x"."year" AS "X1" , "x"."month" AS "X2" , "x"."uniquecarrier" AS "X3" , "x"."airlineid" AS "X4" , "x"."originstatename" AS "X5" , "y"."code" AS "X6" , "y"."description" AS "X7" , (CAST(1 AS INT4) * CAST(1 AS INT4)) AS "X8" , "x"."carrierdelay" AS "X9" , "x"."cancellationcode" AS "X10" FROM "airline"."l_cancellation" AS "y" , "airline"."on_time_on_time_performance_2016" AS "x" WHERE ((CAST("y"."insertxid" AS INT8) <= $_4166391343746179141_$ || start_xid || $_4166391343746179141_$) AND (NOT CAST("y"."insertxid" AS INT8) IN $_4166391343746179141_$ || finished_xid_list || $_4166391343746179141_$ AND ((CAST("y"."deletexid" AS INT8) > $_4166391343746179141_$ || start_xid || $_4166391343746179141_$) OR CAST("y"."deletexid" AS INT8) IN $_4166391343746179141_$ || finished_xid_list || $_4166391343746179141_$))) AND (((CAST("x"."insertxid" AS INT8) > $_4166391343746179141_$ || start_xid || $_4166391343746179141_$) OR CAST("x"."insertxid" AS INT8) IN $_4166391343746179141_$ || finished_xid_list || $_4166391343746179141_$) AND ((CAST("x"."insertxid" AS INT8) <= $_4166391343746179141_$ || end_xid || $_4166391343746179141_$) AND (CAST("x"."deletexid" AS INT8) > $_4166391343746179141_$ || end_xid || $_4166391343746179141_$)))) UNION ALL ((SELECT "x"."year" AS "X1" , "x"."month" AS "X2" , "x"."uniquecarrier" AS "X3" , "x"."airlineid" AS "X4" , "x"."originstatename" AS "X5" , "y"."code" AS "X6" , "y"."description" AS "X7" , (CAST(-1 AS INT4) * CAST(1 AS INT4)) AS "X8" , "x"."carrierdelay" AS "X9" , "x"."cancellationcode" AS "X10" FROM "airline"."l_cancellation" AS "y" , "airline"."on_time_on_time_performance_2016" AS "x" WHERE ((CAST("y"."insertxid" AS INT8) <= $_4166391343746179141_$ || start_xid || $_4166391343746179141_$) AND (NOT CAST("y"."insertxid" AS INT8) IN $_4166391343746179141_$ || finished_xid_list || $_4166391343746179141_$ AND (((CAST("y"."deletexid" AS INT8) > $_4166391343746179141_$ || start_xid || $_4166391343746179141_$) OR CAST("y"."deletexid" AS INT8) IN $_4166391343746179141_$ || finished_xid_list || $_4166391343746179141_$) AND (CAST("y"."deletexid" AS INT8) <= $_4166391343746179141_$ || end_xid || $_4166391343746179141_$)))) AND ((CAST("x"."insertxid" AS INT8) <= $_4166391343746179141_$ || end_xid || $_4166391343746179141_$) AND (CAST("x"."deletexid" AS INT8) > $_4166391343746179141_$ || end_xid || $_4166391343746179141_$))) UNION ALL (SELECT "x"."year" AS "X1" , "x"."month" AS "X2" , "x"."uniquecarrier" AS "X3" , "x"."airlineid" AS "X4" , "x"."originstatename" AS "X5" , "y"."code" AS "X6" , "y"."description" AS "X7" , (CAST(1 AS INT4) * CAST(-1 AS INT4)) AS "X8" , "x"."carrierdelay" AS "X9" , "x"."cancellationcode" AS "X10" FROM "airline"."l_cancellation" AS "y" , "airline"."on_time_on_time_performance_2016" AS "x" WHERE ((CAST("y"."insertxid" AS INT8) <= $_4166391343746179141_$ || start_xid || $_4166391343746179141_$) AND (NOT CAST("y"."insertxid" AS INT8) IN $_4166391343746179141_$ || finished_xid_list || $_4166391343746179141_$ AND ((CAST("y"."deletexid" AS INT8) > $_4166391343746179141_$ || start_xid || $_4166391343746179141_$) OR CAST("y"."deletexid" AS INT8) IN $_4166391343746179141_$ || finished_xid_list || $_4166391343746179141_$))) AND ((CAST("x"."insertxid" AS INT8) <= $_4166391343746179141_$ || start_xid || $_4166391343746179141_$) AND (NOT CAST("x"."insertxid" AS INT8) IN $_4166391343746179141_$ || finished_xid_list || $_4166391343746179141_$ AND (((CAST("x"."deletexid" AS INT8) > $_4166391343746179141_$ || start_xid || $_4166391343746179141_$) OR CAST("x"."deletexid" AS INT8) IN $_4166391343746179141_$ || finished_xid_list || $_4166391343746179141_$) AND (CAST("x"."deletexid" AS INT8) <= $_4166391343746179141_$ || end_xid || $_4166391343746179141_$)))))))) AS "derived_table1" WHERE "derived_table1"."X6" = "derived_table1"."X10" GROUP BY "derived_table1"."X1" , "derived_table1"."X2" , "derived_table1"."X3" , "derived_table1"."X4" , "derived_table1"."X5" , "derived_table1"."X6" , CASE WHEN "derived_table1"."X7" IS NULL THEN CAST('misc' AS VARCHAR) ELSE "derived_table1"."X7" END) $_4166391343746179141_$; EXECUTE $_4166391343746179141_$ CREATE TEMPORARY TABLE "mv_tbl__cancelled_flights__0__insert_tmp" AS (SELECT "mv_tbl__cancelled_flights__0_tmp"."grvar_1" , "mv_tbl__cancelled_flights__0_tmp"."grvar_2" , "mv_tbl__cancelled_flights__0_tmp"."grvar_3" , "mv_tbl__cancelled_flights__0_tmp"."grvar_4" , "mv_tbl__cancelled_flights__0_tmp"."grvar_5" , "mv_tbl__cancelled_flights__0_tmp"."grvar_6" , "mv_tbl__cancelled_flights__0_tmp"."grvar_7" , CASE WHEN "mv_tbl__cancelled_flights__0"."aggvar_1" IS NULL THEN "mv_tbl__cancelled_flights__0_tmp"."aggvar_1" ELSE "mv_tbl__cancelled_flights__0"."aggvar_1" + "mv_tbl__cancelled_flights__0_tmp"."aggvar_1" END AS "aggvar_1" , CASE WHEN "mv_tbl__cancelled_flights__0"."aggvar_2" IS NULL THEN "mv_tbl__cancelled_flights__0_tmp"."aggvar_2" ELSE "mv_tbl__cancelled_flights__0"."aggvar_2" + "mv_tbl__cancelled_flights__0_tmp"."aggvar_2" END AS "aggvar_2" , CASE WHEN "mv_tbl__cancelled_flights__0".num_rec IS NULL THEN "mv_tbl__cancelled_flights__0_tmp".num_rec ELSE "mv_tbl__cancelled_flights__0".num_rec + "mv_tbl__cancelled_flights__0_tmp".num_rec END AS num_rec FROM "mv_tbl__cancelled_flights__0_tmp" LEFT OUTER JOIN "airline"."mv_tbl__cancelled_flights__0" ON (coalesce("mv_tbl__cancelled_flights__0"."grvar_1" , 0) = coalesce("mv_tbl__cancelled_flights__0_tmp"."grvar_1" , 0) AND ("mv_tbl__cancelled_flights__0"."grvar_1" IS NULL = "mv_tbl__cancelled_flights__0_tmp"."grvar_1" IS NULL)) AND (coalesce("mv_tbl__cancelled_flights__0"."grvar_2" , 0) = coalesce("mv_tbl__cancelled_flights__0_tmp"."grvar_2" , 0) AND ("mv_tbl__cancelled_flights__0"."grvar_2" IS NULL = "mv_tbl__cancelled_flights__0_tmp"."grvar_2" IS NULL)) AND (coalesce("mv_tbl__cancelled_flights__0"."grvar_3" , '') = coalesce("mv_tbl__cancelled_flights__0_tmp"."grvar_3" , '') AND ("mv_tbl__cancelled_flights__0"."grvar_3" IS NULL = "mv_tbl__cancelled_flights__0_tmp"."grvar_3" IS NULL)) AND (coalesce("mv_tbl__cancelled_flights__0"."grvar_4" , 0) = coalesce("mv_tbl__cancelled_flights__0_tmp"."grvar_4" , 0) AND ("mv_tbl__cancelled_flights__0"."grvar_4" IS NULL = "mv_tbl__cancelled_flights__0_tmp"."grvar_4" IS NULL)) AND (coalesce("mv_tbl__cancelled_flights__0"."grvar_5" , '') = coalesce("mv_tbl__cancelled_flights__0_tmp"."grvar_5" , '') AND ("mv_tbl__cancelled_flights__0"."grvar_5" IS NULL = "mv_tbl__cancelled_flights__0_tmp"."grvar_5" IS NULL)) AND (coalesce("mv_tbl__cancelled_flights__0"."grvar_6" , '') = coalesce("mv_tbl__cancelled_flights__0_tmp"."grvar_6" , '') AND ("mv_tbl__cancelled_flights__0"."grvar_6" IS NULL = "mv_tbl__cancelled_flights__0_tmp"."grvar_6" IS NULL)) AND (coalesce("mv_tbl__cancelled_flights__0"."grvar_7" , '') = coalesce("mv_tbl__cancelled_flights__0_tmp"."grvar_7" , '') AND ("mv_tbl__cancelled_flights__0"."grvar_7" IS NULL = "mv_tbl__cancelled_flights__0_tmp"."grvar_7" IS NULL)) WHERE "mv_tbl__cancelled_flights__0_tmp".num_rec + NVL("mv_tbl__cancelled_flights__0".num_rec , 0) > 0) $_4166391343746179141_$; DELETE FROM "airline"."mv_tbl__cancelled_flights__0" USING "mv_tbl__cancelled_flights__0_tmp" WHERE "mv_tbl__cancelled_flights__0".insertxid < end_xid AND "mv_tbl__cancelled_flights__0".deletexid = 9223372036854775807 AND (coalesce("mv_tbl__cancelled_flights__0"."grvar_1" , 0) = coalesce("mv_tbl__cancelled_flights__0_tmp"."grvar_1" , 0) AND ("mv_tbl__cancelled_flights__0"."grvar_1" IS NULL = "mv_tbl__cancelled_flights__0_tmp"."grvar_1" IS NULL)) AND (coalesce("mv_tbl__cancelled_flights__0"."grvar_2" , 0) = coalesce("mv_tbl__cancelled_flights__0_tmp"."grvar_2" , 0) AND ("mv_tbl__cancelled_flights__0"."grvar_2" IS NULL = "mv_tbl__cancelled_flights__0_tmp"."grvar_2" IS NULL)) AND (coalesce("mv_tbl__cancelled_flights__0"."grvar_3" , '') = coalesce("mv_tbl__cancelled_flights__0_tmp"."grvar_3" , '') AND ("mv_tbl__cancelled_flights__0"."grvar_3" IS NULL = "mv_tbl__cancelled_flights__0_tmp"."grvar_3" IS NULL)) AND (coalesce("mv_tbl__cancelled_flights__0"."grvar_4" , 0) = coalesce("mv_tbl__cancelled_flights__0_tmp"."grvar_4" , 0) AND ("mv_tbl__cancelled_flights__0"."grvar_4" IS NULL = "mv_tbl__cancelled_flights__0_tmp"."grvar_4" IS NULL)) AND (coalesce("mv_tbl__cancelled_flights__0"."grvar_5" , '') = coalesce("mv_tbl__cancelled_flights__0_tmp"."grvar_5" , '') AND ("mv_tbl__cancelled_flights__0"."grvar_5" IS NULL = "mv_tbl__cancelled_flights__0_tmp"."grvar_5" IS NULL)) AND (coalesce("mv_tbl__cancelled_flights__0"."grvar_6" , '') = coalesce("mv_tbl__cancelled_flights__0_tmp"."grvar_6" , '') AND ("mv_tbl__cancelled_flights__0"."grvar_6" IS NULL = "mv_tbl__cancelled_flights__0_tmp"."grvar_6" IS NULL)) AND (coalesce("mv_tbl__cancelled_flights__0"."grvar_7" , '') = coalesce("mv_tbl__cancelled_flights__0_tmp"."grvar_7" , '') AND ("mv_tbl__cancelled_flights__0"."grvar_7" IS NULL = "mv_tbl__cancelled_flights__0_tmp"."grvar_7" IS NULL)); INSERT INTO "airline"."mv_tbl__cancelled_flights__0" (SELECT * FROM "mv_tbl__cancelled_flights__0__insert_tmp"); DROP TABLE "mv_tbl__cancelled_flights__0_tmp"; DROP TABLE "mv_tbl__cancelled_flights__0__insert_tmp"; END IF;  END; 

